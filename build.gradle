apply plugin: 'java'

def configDir = new File(rootDir, 'config')
def cdh4rel = 'cdh4.3.0'
def hadoop_version = project.getProperties().get('hadoop_version', 'cdh4')
def hadoopVersionMap = [
        "0.23": "0.23.10",
        "1.0" : "1.0.4",
        "1.1" : "1.1.2",
        "cdh4": "2.0.0-${cdh4rel}",
        "2.2" : "2.2.0"
]
def hadoopArtifactVersion = hadoopVersionMap[hadoop_version]

buildscript {
    repositories {
        mavenLocal()
        mavenCentral()
        maven { url 'https://oss.sonatype.org/content/repositories/snapshots' }
    }
    dependencies {
        classpath 'me.trnl:github-release-gradle-plugin:0.1'
    }
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.9'
}

configure(subprojects) {
    apply plugin: 'java'
    apply plugin: 'maven'
    apply plugin: 'checkstyle'
    apply plugin: 'findbugs'

    repositories {
        mavenCentral()
        mavenLocal()
        maven { url "https://repository.cloudera.com/artifactory/cloudera-repos/" }
    }

    group = 'org.mongodb'
    version = '1.2.0'
    jar {
        classifier = "hadoop_${hadoop_version}"
    }

    sourceCompatibility = '1.6'
    targetCompatibility = '1.6'

    dependencies {
        compile "org.mongodb:mongo-java-driver:2.11.3"

        testCompile 'junit:junit:4.11'
        testCompile 'org.hamcrest:hamcrest-all:1.3'
    }

    /* Compiling */
    tasks.withType(AbstractCompile) {
        options.encoding = 'ISO-8859-1'
        options.fork = true
        options.debug = true
//        options.compilerArgs = ['-Xlint:all', '-Xlint:-options']
    }

    project.ext.buildingWith = { n ->
        project.hasProperty(n) && project.property(n).toBoolean()
    }

    /* Testing */
    tasks.withType(Test) {
        maxParallelForks = 1

        beforeTest { descr ->
            logger.info("[Test ${descr.className} > ${descr.name}]")
        }
    }

    task testAll(dependsOn: tasks.withType(Test))
    check.dependsOn testAll

    /* Code quality */
    checkstyle {
        configFile = new File("$configDir/checkstyle.xml")

    }

    checkstyleTest {
        classpath += configurations.compile
    }

    checkstyleMain {
        classpath += configurations.compile
    }

    findbugs {
        excludeFilter = new File("$configDir/findbugs-exclude.xml")
        sourceSets = [sourceSets.main]
    }

    tasks.withType(FindBugs) {
        reports {
            xml.enabled = project.buildingWith('xmlReports.enabled')
            html.enabled = !project.buildingWith('xmlReports.enabled')
        }
    }

    task listDependencies << {
        configurations.compile.each { File file -> println file }
    }
}

project(":core") {
    archivesBaseName = "mongo-hadoop-core"

    dependencies {
        switch (hadoop_version) {
            case ("0.23"):
                compile "org.apache.hadoop:hadoop-common:${hadoopArtifactVersion}"
                mapReduceDeps(it, hadoopArtifactVersion)
                break
            case ("1.0"):
                compile "org.apache.hadoop:hadoop-core:${hadoopArtifactVersion}"
                break
            case ("1.1"):
                compile "org.apache.hadoop:hadoop-core:${hadoopArtifactVersion}"
                break
            case ("cdh4"):
                compile "org.apache.hadoop:hadoop-common:${hadoopArtifactVersion}"
                mapReduceDeps(it, hadoopArtifactVersion)
                break
            case ("2.2"):
                compile "org.apache.hadoop:hadoop-common:${hadoopArtifactVersion}"
                mapReduceDeps(it, hadoopArtifactVersion)
                break
            default:
                throw new GradleException("Unknown hadoop version: ${hadoop_version}")
                break
        }
    }
}

project(":hive") {
    archivesBaseName = "mongo-hadoop-hive"
    dependencies {
        compile project(':core')

        compile "org.apache.hive:hive-exec:0.10.0"
        if (hadoop_version == "cdh4") {
            compile "org.apache.hive:hive-serde:0.10.0-cdh4.2.0"
        } else {
            compile "org.apache.hive:hive-serde:0.10.0"
        }
    }
}

project(":pig") {
    archivesBaseName = "mongo-hadoop-pig"
    dependencies {
        compile project(':core')
        compile "org.antlr:antlr:3.4"

        if (hadoop_version == "cdh4") {
            compile "org.apache.pig:pig:0.10.0-cdh4.2.0"
        } else {
            compile "org.apache.pig:pig:0.9.2"
        }
    }

    jar {
        from project(':core').sourceSets.main.output
        from sourceSets.main.output

        configurations.compile.filter {
            it.name.startsWith('mongo-java-driver')
        }.each {
            from zipTree(it)
        }
    }

}

project(":streaming") {
    archivesBaseName = "mongo-hadoop-streaming"

    dependencies {
        compile project(':core')
        compile "org.apache.hadoop:hadoop-streaming:${hadoopArtifactVersion}"
    }

    jar {
        onlyIf { hadoop_version != "1.0" }

        from project(':core').sourceSets.main.output
        from sourceSets.main.output

        configurations.compile.filter {
            it.name.startsWith('mongo-java-driver')
        }.each {
            from zipTree(it)
        }
    }
}

project(":flume") {
    dependencies {
        compile project(':core')
        compile "com.cloudera:flume-core:0.9.4-cdh3u3"
    }
}

project(":examples/ufo_sightings") {
    dependencies {
        compile project(':core')
    }
    jar {
        baseName = project.name.split('/')[1]
    }

}

project(":examples/treasury_yield") {
    dependencies {
        compile project(':core')
    }
    jar {
        baseName = project.name.split('/')[1]
    }
}

project(":examples/enron") {
    dependencies {
        compile project(':core')
    }
    jar {
        baseName = project.name.split('/')[1]
    }

}

project(":examples/sensors") {
    dependencies {
        compile project(':core')
    }
    jar {
        baseName = project.name.split('/')[1]
    }

}

/*
task('build-all') {
    ["0.23", "1.0", "1.1", "cdh4", "2.2"].each {
        println "Builder with $it"
        hadoop_version = it
        project.cleanCompileJava
        project.test
        project.jar
    }
}
*/


task yieldHistorical(type: Exec) {
    commandLine "mongoimport", "-d", "mongo_hadoop", "-c", "yield_historical.in", "--drop",
                "examples/treasury_yield/src/main/resources/yield_historical_in.json"
}

task ufoSightings(type: Exec) {
    commandLine "mongoimport", "-d", "mongo_hadoop", "-c", "ufo_sightings.in", "--drop",
                "examples/ufo_sightings/src/main/resources/ufo_awesome.json"
}

task loadSampleDataTask(dependsOn: [":yieldHistorical", ":ufoSightings"]) {
}

def mapReduceDeps(it, version) {
    ["core", "common", "shuffle", "app", "jobclient"].each { module ->
        it.compile("org.apache.hadoop:hadoop-mapreduce-client-${module}:${version}") {
            exclude group: "org.apache.hadoop", module: "hadoop-hdfs"
        }
    }
}
